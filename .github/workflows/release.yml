name: Create Release binaries

on:
    release:
      types: [created]
 
jobs:
    buildallplatforms:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        
        steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0 # Mandatory to use the extract version from tag action
        
        - name: Extract version from tag
          id: get_version
          uses: dhkatz/get-version-action@v3.0.0

        - name: Add executive summary to release body
          uses: softprops/action-gh-release@v2
          with:
            append_body: true
            body_path: buildscripts/releasenotestintro.md
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        - name: Set up Go
          uses: actions/setup-go@v4
          with:
            go-version: '1.24'
            cache: false

        - name: Build All Platforms
          shell: pwsh
          run: |
            Write-Host "Building all platforms with version: ${{ steps.get_version.outputs.version }}" -ForegroundColor Green
            
            # Get Git information for GitHub Actions context
            $gitCommit = git rev-parse HEAD
            $gitCommitShort = git rev-parse --short HEAD
            $repoUrl = "${{ github.server_url }}/${{ github.repository }}"
            $releaseTag = "${{ steps.get_version.outputs.version }}"
            $gitBranch = "$repoUrl/releases/tag/$releaseTag"
            $buildTime = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
            # Remove 'v' prefix from version if present
            $versionClean = "${{ steps.get_version.outputs.version }}".TrimStart('v')
            $version = "$versionClean-$gitCommitShort"
            
            Write-Host "Git commit: $gitCommitShort ($gitCommit)" -ForegroundColor Cyan
            Write-Host "Git branch: $gitBranch" -ForegroundColor Cyan
            Write-Host "Build time: $buildTime" -ForegroundColor Cyan
            Write-Host "Version: $version" -ForegroundColor Cyan
            
            # Create bin directory
            $binDir = "bin"
            if (-not (Test-Path -Path $binDir)) {
                New-Item -ItemType Directory -Path $binDir | Out-Null
                Write-Host "Created bin directory" -ForegroundColor Green
            }
            
            # Build function integrated from build.ps1
            function Build-Platform {
                param (
                    [string]$GOOS,
                    [string]$GOARCH = "amd64",
                    [string]$GitCommit,
                    [string]$GitBranch,
                    [string]$BuildTime,
                    [string]$Version
                )
                
                Write-Host "Building for $GOOS-$GOARCH..." -ForegroundColor Yellow
                
                # Determine output filename based on OS
                $outputFile = if ($GOOS -eq "windows") {
                    "gitsqlite-$GOOS-$GOARCH.exe"
                } elseif ($GOOS -eq "darwin") {
                    "gitsqlite-macos-$GOARCH"
                } else {
                    "gitsqlite-$GOOS-$GOARCH"
                }
                
                # Build ldflags with version information
                $ldflagsString = "-X 'github.com/danielsiegl/gitsqlite/internal/version.GitCommit=$GitCommit' -X 'github.com/danielsiegl/gitsqlite/internal/version.GitBranch=$GitBranch' -X 'github.com/danielsiegl/gitsqlite/internal/version.BuildTime=$BuildTime' -X 'github.com/danielsiegl/gitsqlite/internal/version.Version=$Version'"
                
                # Set environment variables and build
                $env:GOOS = $GOOS
                $env:GOARCH = $GOARCH
                $env:CGO_ENABLED = "0"
                
                Write-Host "Executing: go build -ldflags `"$ldflagsString`" -o `"$outputFile`"" -ForegroundColor Gray
                & go build -ldflags $ldflagsString -o $outputFile
                
                if ($LASTEXITCODE -ne 0) {
                    throw "Build failed for $GOOS-$GOARCH with exit code $LASTEXITCODE"
                }
                
                # Move to bin directory
                Move-Item -Path $outputFile -Destination $binDir -Force
                Write-Host "✓ Built and moved to bin directory: $binDir/$outputFile" -ForegroundColor Green
            }
            
            # Build for all platforms
            try {
                Build-Platform -GOOS "linux" -GOARCH "amd64" -GitCommit $gitCommit -GitBranch $gitBranch -BuildTime $buildTime -Version $version
                Build-Platform -GOOS "linux" -GOARCH "arm64" -GitCommit $gitCommit -GitBranch $gitBranch -BuildTime $buildTime -Version $version
                Build-Platform -GOOS "windows" -GOARCH "amd64" -GitCommit $gitCommit -GitBranch $gitBranch -BuildTime $buildTime -Version $version
                Build-Platform -GOOS "windows" -GOARCH "arm64" -GitCommit $gitCommit -GitBranch $gitBranch -BuildTime $buildTime -Version $version 
                Build-Platform -GOOS "darwin" -GOARCH "arm64" -GitCommit $gitCommit -GitBranch $gitBranch -BuildTime $buildTime -Version $version
                
                Write-Host "✓ All builds completed successfully!" -ForegroundColor Green
                
                # List all built files
                Write-Host "`nBuilt files:" -ForegroundColor Cyan
                Get-ChildItem -Path $binDir | ForEach-Object {
                    $size = [math]::Round($_.Length / 1MB, 2)
                    Write-Host "  $($_.Name) ($size MB)" -ForegroundColor White
                }
            } catch {
                Write-Host "✗ Build failed: $($_.Exception.Message)" -ForegroundColor Red
                exit 1
            }

        - name: Create Debian Package for Linux AMD64
          shell: bash
          run: |
            echo "Creating Debian package for Linux AMD64..."
            
            # Install dpkg-deb if not available
            sudo apt-get update && sudo apt-get install -y dpkg-dev
            
            # Extract version from tag (remove 'v' prefix)
            VERSION="${{ steps.get_version.outputs.version }}"
            VERSION_CLEAN="${VERSION#v}"
            
            # Update changelog with actual version
            sed -i "s/0.0.0/${VERSION_CLEAN}/" debian/changelog
            sed -i "s/UNRELEASED/stable/" debian/changelog
            sed -i "s/Wed, 05 Feb 2026 17:00:00 +0000/$(date -R)/" debian/changelog
            
            # Create package directory structure
            PKG_DIR="gitsqlite_${VERSION_CLEAN}_amd64"
            mkdir -p "${PKG_DIR}/DEBIAN"
            mkdir -p "${PKG_DIR}/usr/bin"
            
            # Copy binary
            cp bin/gitsqlite-linux-amd64 "${PKG_DIR}/usr/bin/gitsqlite"
            chmod 755 "${PKG_DIR}/usr/bin/gitsqlite"
            
            # Create DEBIAN/control file
            # NOTE: Keep this content in sync with ARM64 package, main.yml workflow, and debian/control
            cat > "${PKG_DIR}/DEBIAN/control" << EOF
            Package: gitsqlite
            Version: ${VERSION_CLEAN}
            Section: vcs
            Priority: optional
            Architecture: amd64
            Depends: sqlite3
            Maintainer: Daniel Siegl <daniel@siegl.dev>
            Description: Git clean/smudge/diff filter for SQLite databases
             gitsqlite is a Git clean/smudge/diff filter for storing SQLite databases
             in plain text SQL, enabling meaningful diffs and merges.
             .
             Features:
              - Byte-by-byte identical dumps across Windows/Linux/macOS
              - Consistent float rounding (deterministic dumps)
              - Strips SQLite's internal/system tables from dumps
              - Temp-file I/O for robustness
              - Handles broken pipes with Git GUI Clients
              - Optional logging for diagnostics
              - Schema/data separation for cleaner diffs
            Homepage: https://github.com/danielsiegl/gitsqlite
            EOF
            
            # Build the package
            dpkg-deb --build "${PKG_DIR}"
            
            # Move to bin directory for upload
            mv "${PKG_DIR}.deb" "bin/gitsqlite_${VERSION_CLEAN}_amd64.deb"
            
            echo "✓ Debian package created: bin/gitsqlite_${VERSION_CLEAN}_amd64.deb"
            ls -lh "bin/gitsqlite_${VERSION_CLEAN}_amd64.deb"

        - name: Create Debian Package for Linux ARM64
          shell: bash
          run: |
            echo "Creating Debian package for Linux ARM64..."
            
            # Extract version from tag (remove 'v' prefix)
            VERSION="${{ steps.get_version.outputs.version }}"
            VERSION_CLEAN="${VERSION#v}"
            
            # Create package directory structure
            PKG_DIR="gitsqlite_${VERSION_CLEAN}_arm64"
            mkdir -p "${PKG_DIR}/DEBIAN"
            mkdir -p "${PKG_DIR}/usr/bin"
            
            # Copy binary
            cp bin/gitsqlite-linux-arm64 "${PKG_DIR}/usr/bin/gitsqlite"
            chmod 755 "${PKG_DIR}/usr/bin/gitsqlite"
            
            # Create DEBIAN/control file
            # NOTE: Keep this content in sync with AMD64 package, main.yml workflow, and debian/control
            cat > "${PKG_DIR}/DEBIAN/control" << EOF
            Package: gitsqlite
            Version: ${VERSION_CLEAN}
            Section: vcs
            Priority: optional
            Architecture: arm64
            Depends: sqlite3
            Maintainer: Daniel Siegl <daniel@siegl.dev>
            Description: Git clean/smudge/diff filter for SQLite databases
             gitsqlite is a Git clean/smudge/diff filter for storing SQLite databases
             in plain text SQL, enabling meaningful diffs and merges.
             .
             Features:
              - Byte-by-byte identical dumps across Windows/Linux/macOS
              - Consistent float rounding (deterministic dumps)
              - Strips SQLite's internal/system tables from dumps
              - Temp-file I/O for robustness
              - Handles broken pipes with Git GUI Clients
              - Optional logging for diagnostics
              - Schema/data separation for cleaner diffs
            Homepage: https://github.com/danielsiegl/gitsqlite
            EOF
            
            # Build the package
            dpkg-deb --build "${PKG_DIR}"
            
            # Move to bin directory for upload
            mv "${PKG_DIR}.deb" "bin/gitsqlite_${VERSION_CLEAN}_arm64.deb"
            
            echo "✓ Debian package created: bin/gitsqlite_${VERSION_CLEAN}_arm64.deb"
            ls -lh "bin/gitsqlite_${VERSION_CLEAN}_arm64.deb"

        - name: Upload Linux AMD64 Binary
          uses: svenstaro/upload-release-action@2.9.0
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: bin/gitsqlite-linux-amd64
            asset_name: gitsqlite-linux-amd64
            tag: ${{ github.ref }}
            overwrite: true

        - name: Upload Linux ARM64 Binary
          uses: svenstaro/upload-release-action@2.9.0
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: bin/gitsqlite-linux-arm64
            asset_name: gitsqlite-linux-arm64
            tag: ${{ github.ref }}
            overwrite: true

        - name: Upload Windows AMD64 Binary
          uses: svenstaro/upload-release-action@2.9.0
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: bin/gitsqlite-windows-amd64.exe
            asset_name: gitsqlite-windows-amd64.exe
            tag: ${{ github.ref }}
            overwrite: true

        - name: Upload Windows ARM64 Binary
          uses: svenstaro/upload-release-action@2.9.0
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: bin/gitsqlite-windows-arm64.exe
            asset_name: gitsqlite-windows-arm64.exe
            tag: ${{ github.ref }}
            overwrite: true
        - name: Upload macOS ARM64 Binary
          uses: svenstaro/upload-release-action@2.9.0
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: bin/gitsqlite-macos-arm64
            asset_name: gitsqlite-macos-arm64
            tag: ${{ github.ref }}
            overwrite: true

        - name: Upload Debian Package AMD64
          uses: svenstaro/upload-release-action@2.9.0
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: bin/gitsqlite_*_amd64.deb
            asset_name: gitsqlite_${{ steps.get_version.outputs.version }}_amd64.deb
            tag: ${{ github.ref }}
            overwrite: true
            file_glob: true

        - name: Upload Debian Package ARM64
          uses: svenstaro/upload-release-action@2.9.0
          with:
            repo_token: ${{ secrets.GITHUB_TOKEN }}
            file: bin/gitsqlite_*_arm64.deb
            asset_name: gitsqlite_${{ steps.get_version.outputs.version }}_arm64.deb
            tag: ${{ github.ref }}
            overwrite: true
            file_glob: true

    winget:
        needs: buildallplatforms
        runs-on: windows-latest
        steps:
        - name: Publish gitsqlite to WinGet
          uses: vedantmgoyal9/winget-releaser@main
          with:
            identifier: danielsiegl.gitsqlite
            # Match your Windows artifact from the release page:
            installers-regex: '\bgitsqlite-windows-amd64\.exe$'
            # Optional: keep only the latest N versions in WinGet (0 = unlimited)
            max-versions-to-keep: 5
            token: ${{ secrets.WINGET_TOKEN }}