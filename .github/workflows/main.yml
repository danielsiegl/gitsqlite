# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Build gitsqlite

on:
  push:
  
jobs:
  build:
    defaults:
      run:
        shell: pwsh
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
        cache: false
    - name: Check gofmt compliance
      shell: bash
      run: |
        gofmt -s -l .
        if [ "$(gofmt -s -l . | wc -l)" -ne 0 ]; then
          echo "Go code is not gofmt compliant. Run 'gofmt -s -w .' to fix." >&2
          exit 1
        fi
    - name: Build
      run: ./buildscripts/build.ps1
    
    - name: Create Debian Package for Linux AMD64
      shell: bash
      run: |
        echo "Creating Debian package for Linux AMD64..."
        
        # Install dpkg-deb if not available
        sudo apt-get update && sudo apt-get install -y dpkg-dev
        
        # Use a test version for non-release builds
        VERSION="0.0.0-dev+$(git rev-parse --short HEAD)"
        
        # Create package directory structure
        PKG_DIR="gitsqlite_${VERSION}_amd64"
        mkdir -p "${PKG_DIR}/DEBIAN"
        mkdir -p "${PKG_DIR}/usr/bin"
        
        # Copy binary
        cp bin/gitsqlite-linux-amd64 "${PKG_DIR}/usr/bin/gitsqlite"
        chmod 755 "${PKG_DIR}/usr/bin/gitsqlite"
        
        # Create DEBIAN/control file
        # NOTE: Keep this content in sync with ARM64 package, release.yml workflow, and debian/control
        cat > "${PKG_DIR}/DEBIAN/control" << EOF
        Package: gitsqlite
        Version: ${VERSION}
        Section: vcs
        Priority: optional
        Architecture: amd64
        Depends: sqlite3
        Maintainer: Daniel Siegl <daniel@siegl.dev>
        Description: Git clean/smudge/diff filter for SQLite databases
         gitsqlite is a Git clean/smudge/diff filter for storing SQLite databases
         in plain text SQL, enabling meaningful diffs and merges.
         .
         Features:
          - Byte-by-byte identical dumps across Windows/Linux/macOS
          - Consistent float rounding (deterministic dumps)
          - Strips SQLite's internal/system tables from dumps
          - Temp-file I/O for robustness
          - Handles broken pipes with Git GUI Clients
          - Optional logging for diagnostics
          - Schema/data separation for cleaner diffs
        Homepage: https://github.com/danielsiegl/gitsqlite
        EOF
        
        # Build the package
        dpkg-deb --build "${PKG_DIR}"
        
        # Move to bin directory for upload
        mv "${PKG_DIR}.deb" "bin/gitsqlite_${VERSION}_amd64.deb"
        
        echo "✓ Debian package created: bin/gitsqlite_${VERSION}_amd64.deb"
        ls -lh "bin/gitsqlite_${VERSION}_amd64.deb"

    - name: Create Debian Package for Linux ARM64
      shell: bash
      run: |
        echo "Creating Debian package for Linux ARM64..."
        
        # Use a test version for non-release builds
        VERSION="0.0.0-dev+$(git rev-parse --short HEAD)"
        
        # Create package directory structure
        PKG_DIR="gitsqlite_${VERSION}_arm64"
        mkdir -p "${PKG_DIR}/DEBIAN"
        mkdir -p "${PKG_DIR}/usr/bin"
        
        # Copy binary
        cp bin/gitsqlite-linux-arm64 "${PKG_DIR}/usr/bin/gitsqlite"
        chmod 755 "${PKG_DIR}/usr/bin/gitsqlite"
        
        # Create DEBIAN/control file
        # NOTE: Keep this content in sync with AMD64 package, release.yml workflow, and debian/control
        cat > "${PKG_DIR}/DEBIAN/control" << EOF
        Package: gitsqlite
        Version: ${VERSION}
        Section: vcs
        Priority: optional
        Architecture: arm64
        Depends: sqlite3
        Maintainer: Daniel Siegl <daniel@siegl.dev>
        Description: Git clean/smudge/diff filter for SQLite databases
         gitsqlite is a Git clean/smudge/diff filter for storing SQLite databases
         in plain text SQL, enabling meaningful diffs and merges.
         .
         Features:
          - Byte-by-byte identical dumps across Windows/Linux/macOS
          - Consistent float rounding (deterministic dumps)
          - Strips SQLite's internal/system tables from dumps
          - Temp-file I/O for robustness
          - Handles broken pipes with Git GUI Clients
          - Optional logging for diagnostics
          - Schema/data separation for cleaner diffs
        Homepage: https://github.com/danielsiegl/gitsqlite
        EOF
        
        # Build the package
        dpkg-deb --build "${PKG_DIR}"
        
        # Move to bin directory for upload
        mv "${PKG_DIR}.deb" "bin/gitsqlite_${VERSION}_arm64.deb"
        
        echo "✓ Debian package created: bin/gitsqlite_${VERSION}_arm64.deb"
        ls -lh "bin/gitsqlite_${VERSION}_arm64.deb"
    
    - name: Upload binary Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin/**/*
        retention-days: 5

  create-smoketest-db:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Create smoketest database
      shell: pwsh
      run: ./buildscripts/createtestdatabase.ps1
    - name: Upload smoketest database
      uses: actions/upload-artifact@v4
      with:
        name: smoketest-db
        path: smoketest.db
        retention-days: 5

  test-diff-filter:
    needs: [build, create-smoketest-db]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download binaries
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    - name: Make diff filter binary executable
      run: chmod +x bin/gitsqlite-linux-amd64
    - name: Run diff filter against smoketest.db
      run: ./bin/gitsqlite-linux-amd64 diff smoketest.db > smoketest_diff.sql
    - name: Output line and statement counts
      run: |
        echo "Total lines: $(wc -l < smoketest_diff.sql)"
        echo "CREATE statements: $(grep -c -E '^CREATE ' smoketest_diff.sql)"
        echo "INSERT statements: $(grep -c -E '^INSERT ' smoketest_diff.sql)"
        if grep -q -E '^CREATE ' smoketest_diff.sql && grep -q -E '^INSERT ' smoketest_diff.sql; then
          echo "Diff filter output contains CREATE and INSERT statements."
        else
          echo "Diff filter output missing CREATE or INSERT statements!"
          exit 1
        fi
  test-ubuntu-amd64:
    needs: [build, create-smoketest-db]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    - name: Make Linux binary executable
      run: chmod +x bin/gitsqlite-linux-amd64
    
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    
    - name: Run integrated smoketest
      run: |
        echo "Step 1: Database -> SQL (clean)"
        ./bin/gitsqlite-linux-amd64 clean < smoketest.db > smoketest_output1.sql
        
        echo "Step 2: SQL -> Database (smudge)"
        ./bin/gitsqlite-linux-amd64 smudge < smoketest_output1.sql > smoketest_output2.db
        
        echo "Step 3: Database -> SQL (clean again)"
        ./bin/gitsqlite-linux-amd64 clean < smoketest_output2.db > smoketest_output2.sql
    
    - name: Evaluate test results
      shell: pwsh
      run: ./buildscripts/evaluatetest.ps1

    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-ubuntu-amd64
        path: '*.sql'
        retention-days: 5

  test-ubuntu-arm64:
    needs: [build, create-smoketest-db]
    runs-on: ubuntu-24.04-arm
    steps:
    - uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    
    - name: Make Linux ARM64 binary executable
      run: chmod +x bin/gitsqlite-linux-arm64
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    
    - name: Run integrated smoketest on ARM64
      run: |
        echo "Step 1: Database -> SQL (clean)"
        ./bin/gitsqlite-linux-arm64 clean < smoketest.db > smoketest_output1.sql
        
        echo "Step 2: SQL -> Database (smudge)"
        ./bin/gitsqlite-linux-arm64 smudge < smoketest_output1.sql > smoketest_output2.db
        
        echo "Step 3: Database -> SQL (clean again)"
        ./bin/gitsqlite-linux-arm64 clean < smoketest_output2.db > smoketest_output2.sql
    - name: Evaluate test results
      shell: pwsh
      run: ./buildscripts/evaluatetest.ps1
    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-ubuntu-arm64
        path: '*.sql'
        retention-days: 5
  test-macos-arm64:
    needs: [build, create-smoketest-db]
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    - name: Make macOS binary executable
      run: chmod +x bin/gitsqlite-macos-arm64
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    - name: Run integrated smoketest on macOS
      run: |
        echo "Step 1: Database -> SQL (clean)"
        ./bin/gitsqlite-macos-arm64 clean < smoketest.db > smoketest_output1.sql
        
        echo "Step 2: SQL -> Database (smudge)"
        ./bin/gitsqlite-macos-arm64 smudge < smoketest_output1.sql > smoketest_output2.db
        
        echo "Step 3: Database -> SQL (clean again)"
        ./bin/gitsqlite-macos-arm64 clean < smoketest_output2.db > smoketest_output2.sql
    - name: Evaluate test results
      shell: pwsh
      run: ./buildscripts/evaluatetest.ps1
    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-macos-arm64
        path: '*.sql'
        retention-days: 5


  test-windows-amd64:
    needs: [build, create-smoketest-db]
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    - name: Install SQLite
      run: choco install sqlite -y
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    - name: Run integrated smoketest on Windows
      shell: cmd
      run: |
        REM Step 1: Database -> SQL (clean)
        bin\gitsqlite-windows-amd64.exe clean < smoketest.db > smoketest_output1.sql

        REM Step 2: SQL -> Database (smudge)
        bin\gitsqlite-windows-amd64.exe smudge < smoketest_output1.sql > smoketest_output2.db

        REM Step 3: Database -> SQL (clean again)
        bin\gitsqlite-windows-amd64.exe clean < smoketest_output2.db > smoketest_output2.sql
    - name: Evaluate test results
      shell: pwsh
      run: ./buildscripts/evaluatetest.ps1
    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-windows-amd64
        path: '*.sql'
        retention-days: 5

  test-schema-data-separation:
    needs: [build, create-smoketest-db]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download binaries
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    - name: Make Linux binary executable
      run: chmod +x bin/gitsqlite-linux-amd64
    - name: Test schema/data separation workflow
      run: |
        echo "=== Testing Schema/Data Separation Feature ==="
        
        echo "Step 1: Extract data-only + schema to separate files"
        ./bin/gitsqlite-linux-amd64 -data-only -schema clean < smoketest.db > data_only.sql
        
        echo "Step 2: Verify schema file was created"
        if [ ! -f .gitsqliteschema ]; then
          echo "ERROR: Schema file .gitsqliteschema was not created"
          exit 1
        fi
        
        echo "Step 3: Verify data file contains only INSERT statements (and pragmas)"
        if ! grep -q "INSERT INTO" data_only.sql; then
          echo "ERROR: Data file missing INSERT statements"
          exit 1
        fi
        if grep -q "CREATE TABLE" data_only.sql; then
          echo "ERROR: Data file contains CREATE statements (should be data-only)"
          exit 1
        fi
        
        echo "Step 4: Verify schema file contains only CREATE statements (and pragmas)"
        if ! grep -q "CREATE TABLE" .gitsqliteschema; then
          echo "ERROR: Schema file missing CREATE statements"
          exit 1
        fi
        if grep -q "INSERT INTO" .gitsqliteschema; then
          echo "ERROR: Schema file contains INSERT statements (should be schema-only)"
          exit 1
        fi
        
        echo "Step 5: Restore database from separated files"
        ./bin/gitsqlite-linux-amd64 -schema-file .gitsqliteschema smudge < data_only.sql > restored.db
        
        echo "Step 6: Verify roundtrip integrity"
        ./bin/gitsqlite-linux-amd64 clean < restored.db > roundtrip.sql
        ./bin/gitsqlite-linux-amd64 clean < smoketest.db > original.sql
        
        if ! diff original.sql roundtrip.sql; then
          echo "ERROR: Roundtrip test failed - restored database differs from original"
          exit 1
        fi
        
        echo "Step 7: Test diff operation with schema/data separation"
        ./bin/gitsqlite-linux-amd64 -data-only -schema-file schema_diff.sql diff smoketest.db > data_diff.sql

        # Note: We need to strip hash lines before comparing because:
        # - 'clean' operation adds hash signatures (-- gitsqlite-hash: sha256:...) for Git filter integrity verification
        # - 'diff' operation does NOT add hash signatures (they're unnecessary for viewing/comparing changes)
        # This is intentional behavior, not a bug. We compare the SQL content while ignoring the hash metadata.
        echo "Comparing data-only outputs (ignoring hash lines)..."
        if ! diff <(grep -v "^-- gitsqlite-hash:" data_only.sql) <(grep -v "^-- gitsqlite-hash:" data_diff.sql); then
          echo "ERROR: Clean and diff produce different data-only output"
          exit 1
        fi

        echo "Comparing schema outputs (ignoring hash lines)..."
        if ! diff <(grep -v "^-- gitsqlite-hash:" .gitsqliteschema) <(grep -v "^-- gitsqlite-hash:" schema_diff.sql); then
          echo "ERROR: Clean and diff produce different schema output"
          exit 1
        fi
        
        echo "=== Schema/Data Separation Tests: PASSED ==="
        
        echo "File sizes:"
        echo "Original database: $(wc -c < smoketest.db) bytes"
        echo "Full SQL: $(wc -c < original.sql) bytes" 
        echo "Data-only SQL: $(wc -c < data_only.sql) bytes"
        echo "Schema SQL: $(wc -c < .gitsqliteschema) bytes"
        
        echo "Line counts:"
        echo "Full SQL: $(wc -l < original.sql) lines"
        echo "Data-only SQL: $(wc -l < data_only.sql) lines"  
        echo "Schema SQL: $(wc -l < .gitsqliteschema) lines"
        
    - name: Upload schema/data artifacts
      uses: actions/upload-artifact@v4
      with:
        name: schema-data-separation-artifacts
        path: |
          .gitsqliteschema
          data_only.sql
          schema_diff.sql
          data_diff.sql
          restored.db
          roundtrip.sql
          original.sql
        retention-days: 5

  test-hash-validation:
    needs: [build, create-smoketest-db]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download binaries
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    - name: Make Linux binary executable
      run: chmod +x bin/gitsqlite-linux-amd64
    - name: Test hash validation in smudge operation
      run: |
        echo "=== Testing Hash Validation in Smudge Operation ==="

        # First, create a valid SQL file with hash
        echo "Step 1: Create valid SQL file with hash"
        ./bin/gitsqlite-linux-amd64 clean < smoketest.db > valid.sql
        ORIGINAL_HASH=$(tail -1 valid.sql)
        echo "Original hash: $ORIGINAL_HASH"

        # Test 1: Verify valid file works
        echo ""
        echo "Test 1: Verify smudge works with valid hash"
        if ! ./bin/gitsqlite-linux-amd64 -verify-hash smudge < valid.sql > restored_valid.db 2>&1; then
          echo "ERROR: Smudge failed with valid hash"
          exit 1
        fi
        echo "✓ Smudge succeeded with valid hash"

        # Test 2: Corrupted hash (invalid hash value)
        echo ""
        echo "Test 2: Smudge should fail with corrupted/invalid hash"
        cat > corrupted_hash.sql << 'EOF'
        PRAGMA foreign_keys=OFF;
        BEGIN TRANSACTION;
        CREATE TABLE test (id INTEGER PRIMARY KEY, name TEXT);
        INSERT INTO test VALUES(1,'Alice');
        COMMIT;
        -- gitsqlite-hash: sha256:0000000000000000000000000000000000000000000000000000000000000000
        EOF

        if ./bin/gitsqlite-linux-amd64 -verify-hash smudge < corrupted_hash.sql > output.db 2>&1; then
          echo "ERROR: Smudge should have failed with invalid hash but succeeded"
          exit 1
        fi
        echo "✓ Smudge correctly failed with invalid hash"

        # Test 3: Modified content (hash doesn't match modified content)
        echo ""
        echo "Test 3: Smudge should fail when content is modified but hash is not updated"
        cp valid.sql modified_content.sql
        # Insert a malicious line before COMMIT but keep the original hash
        sed -i '/COMMIT;/i INSERT INTO test VALUES(999,'"'"'Hacker'"'"');' modified_content.sql

        if ./bin/gitsqlite-linux-amd64 -verify-hash smudge < modified_content.sql > output2.db 2>&1; then
          echo "ERROR: Smudge should have failed with modified content but succeeded"
          exit 1
        fi
        echo "✓ Smudge correctly failed with modified content"

        # Test 4: Schema file hash validation
        echo ""
        echo "Test 4: Smudge should fail when schema file hash is invalid"
        ./bin/gitsqlite-linux-amd64 -data-only -schema clean < smoketest.db > data_only.sql

        # Corrupt the schema file by modifying content but keeping hash
        cp .gitsqliteschema corrupted_schema.sql
        sed -i 's/TEXT NOT NULL/TEXT/' corrupted_schema.sql

        if ./bin/gitsqlite-linux-amd64 -verify-hash -schema-file corrupted_schema.sql smudge < data_only.sql > output3.db 2>&1; then
          echo "ERROR: Smudge should have failed with corrupted schema file but succeeded"
          exit 1
        fi
        echo "✓ Smudge correctly failed with corrupted schema file"

        # Test 5: Missing hash line
        echo ""
        echo "Test 5: Smudge should fail when hash line is missing"
        head -n -1 valid.sql > missing_hash.sql

        if ./bin/gitsqlite-linux-amd64 -verify-hash smudge < missing_hash.sql > output4.db 2>&1; then
          echo "ERROR: Smudge should have failed with missing hash but succeeded"
          exit 1
        fi
        echo "✓ Smudge correctly failed with missing hash"

        echo ""
        echo "=== Hash Validation Tests: ALL PASSED ==="

  test-verify-hash-flag:
    needs: [build, create-smoketest-db]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download binaries
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    - name: Download smoketest database
      uses: actions/download-artifact@v4
      with:
        name: smoketest-db
        path: .
    - name: Make Linux binary executable
      run: chmod +x bin/gitsqlite-linux-amd64
    - name: Test -verify-hash flag functionality
      run: |
        echo "=== Testing -verify-hash Flag Functionality ==="

        # Create a valid SQL file with hash
        echo "Step 1: Create valid SQL file"
        ./bin/gitsqlite-linux-amd64 clean < smoketest.db > valid.sql
        echo "✓ Valid SQL file created"

        # Create invalid hash SQL file
        echo ""
        echo "Step 2: Create SQL file with invalid hash"
        cat > invalid_hash.sql << 'EOF'
        PRAGMA foreign_keys=OFF;
        BEGIN TRANSACTION;
        CREATE TABLE test (id INTEGER PRIMARY KEY, name TEXT);
        INSERT INTO test VALUES(1,'TestData');
        COMMIT;
        -- gitsqlite-hash: sha256:0000000000000000000000000000000000000000000000000000000000000000
        EOF
        echo "✓ Invalid hash SQL file created"

        # Create SQL file without hash
        echo ""
        echo "Step 3: Create SQL file without hash"
        cat > no_hash.sql << 'EOF'
        PRAGMA foreign_keys=OFF;
        BEGIN TRANSACTION;
        CREATE TABLE test (id INTEGER PRIMARY KEY, name TEXT);
        INSERT INTO test VALUES(1,'TestData');
        COMMIT;
        EOF
        echo "✓ No hash SQL file created"

        # Test 1: Valid hash with -verify-hash flag (should succeed)
        echo ""
        echo "Test 1: Valid hash WITH -verify-hash flag (should succeed)"
        if ! ./bin/gitsqlite-linux-amd64 -verify-hash smudge < valid.sql > test1.db 2>&1; then
          echo "ERROR: Smudge with valid hash and -verify-hash flag should succeed"
          exit 1
        fi
        echo "✓ Correctly succeeded with valid hash"

        # Test 2: Invalid hash with -verify-hash flag (should fail)
        echo ""
        echo "Test 2: Invalid hash WITH -verify-hash flag (should FAIL)"
        if ./bin/gitsqlite-linux-amd64 -verify-hash smudge < invalid_hash.sql > test2.db 2>&1; then
          echo "ERROR: Smudge with invalid hash and -verify-hash flag should fail"
          exit 1
        fi
        echo "✓ Correctly failed with invalid hash when enforcing"

        # Test 3: Missing hash with -verify-hash flag (should fail)
        echo ""
        echo "Test 3: Missing hash WITH -verify-hash flag (should FAIL)"
        if ./bin/gitsqlite-linux-amd64 -verify-hash smudge < no_hash.sql > test3.db 2>&1; then
          echo "ERROR: Smudge with missing hash and -verify-hash flag should fail"
          exit 1
        fi
        echo "✓ Correctly failed with missing hash when enforcing"

        # Test 4: Invalid hash WITHOUT -verify-hash flag (should succeed)
        echo ""
        echo "Test 4: Invalid hash WITHOUT -verify-hash flag (should succeed)"
        if ! ./bin/gitsqlite-linux-amd64 smudge < invalid_hash.sql > test4.db 2>&1; then
          echo "ERROR: Smudge with invalid hash but no -verify-hash flag should succeed"
          exit 1
        fi
        if [ ! -f test4.db ]; then
          echo "ERROR: Database file was not created"
          exit 1
        fi
        echo "✓ Correctly succeeded without enforcement (non-enforce mode)"

        # Test 5: Missing hash WITHOUT -verify-hash flag (should succeed)
        echo ""
        echo "Test 5: Missing hash WITHOUT -verify-hash flag (should succeed)"
        if ! ./bin/gitsqlite-linux-amd64 smudge < no_hash.sql > test5.db 2>&1; then
          echo "ERROR: Smudge with missing hash but no -verify-hash flag should succeed"
          exit 1
        fi
        if [ ! -f test5.db ]; then
          echo "ERROR: Database file was not created"
          exit 1
        fi
        echo "✓ Correctly succeeded without enforcement (non-enforce mode)"

        # Test 6: Valid hash WITHOUT -verify-hash flag (should succeed)
        echo ""
        echo "Test 6: Valid hash WITHOUT -verify-hash flag (should succeed)"
        if ! ./bin/gitsqlite-linux-amd64 smudge < valid.sql > test6.db 2>&1; then
          echo "ERROR: Smudge with valid hash should always succeed"
          exit 1
        fi
        echo "✓ Correctly succeeded with valid hash"

        echo ""
        echo "=== -verify-hash Flag Tests: ALL PASSED ==="
        echo ""
        echo "Summary:"
        echo "  - With -verify-hash flag: Enforces validation (fails on invalid/missing hash)"
        echo "  - Without -verify-hash flag: Optional validation (logs warnings but continues)"

  cross-evaluate:
    needs: [test-ubuntu-amd64, test-windows-amd64]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Download Ubuntu SQL artifact
      uses: actions/download-artifact@v4
      with:
        name: sql-artifacts-ubuntu-amd64
        path: ubuntu_sql
    - name: Download Windows SQL artifact
      uses: actions/download-artifact@v4
      with:
        name: sql-artifacts-windows-amd64
        path: windows_sql
    - name: Run cross-platform evaluation
      shell: pwsh
      run: |
        $ubuntuFile = (Get-ChildItem ubuntu_sql/*.sql | Select-Object -First 1).FullName
        $windowsFile = (Get-ChildItem windows_sql/*.sql | Select-Object -First 1).FullName
        
        Write-Host "Comparing $ubuntuFile (Ubuntu) with $windowsFile (Windows)"
        ./buildscripts/evaluatetest.ps1 -File1 $ubuntuFile -File2 $windowsFile
    - name: Upload compared SQL files
      uses: actions/upload-artifact@v4
      with:
        name: cross-evaluated-sql-files
        path: |
          ubuntu_sql/*.sql
          windows_sql/*.sql
        retention-days: 5

  test-debian-packages:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    
    - name: Test Debian package AMD64 installation
      run: |
        echo "=== Testing Debian Package AMD64 Installation ==="
        
        # Find and install the Debian package
        DEB_FILE=$(find bin -name "*_amd64.deb" -type f)
        echo "Found Debian package: $DEB_FILE"
        
        # Install the package
        sudo dpkg -i "$DEB_FILE" || true
        
        # Install dependencies if needed
        sudo apt-get update && sudo apt-get install -f -y
        
        # Verify installation
        if ! command -v gitsqlite &> /dev/null; then
          echo "ERROR: gitsqlite command not found after installation"
          exit 1
        fi
        
        echo "✓ gitsqlite installed successfully"
        
        # Test version command
        gitsqlite -version
        
        # Create a simple test database
        sqlite3 test.db "CREATE TABLE test (id INTEGER PRIMARY KEY, name TEXT); INSERT INTO test VALUES(1, 'Test');"
        
        # Test clean operation
        gitsqlite clean < test.db > test.sql
        if [ ! -s test.sql ]; then
          echo "ERROR: Clean operation failed"
          exit 1
        fi
        echo "✓ Clean operation successful"
        
        # Test smudge operation
        gitsqlite smudge < test.sql > test_restored.db
        if [ ! -s test_restored.db ]; then
          echo "ERROR: Smudge operation failed"
          exit 1
        fi
        echo "✓ Smudge operation successful"
        
        # Verify data integrity
        ORIGINAL_COUNT=$(sqlite3 test.db "SELECT COUNT(*) FROM test;")
        RESTORED_COUNT=$(sqlite3 test_restored.db "SELECT COUNT(*) FROM test;")
        
        if [ "$ORIGINAL_COUNT" != "$RESTORED_COUNT" ]; then
          echo "ERROR: Data integrity check failed"
          exit 1
        fi
        echo "✓ Data integrity verified"
        
        echo ""
        echo "=== Debian Package AMD64 Tests: ALL PASSED ==="
    
    - name: Verify package metadata
      run: |
        echo "=== Verifying Debian Package Metadata ==="
        
        DEB_FILE=$(find bin -name "*_amd64.deb" -type f)
        
        # Check package info
        dpkg-deb --info "$DEB_FILE"
        
        # Verify package contents
        echo ""
        echo "Package contents:"
        dpkg-deb --contents "$DEB_FILE"
        
        # Verify control file
        echo ""
        echo "Control file:"
        dpkg-deb --field "$DEB_FILE"
        
        # Check that sqlite3 is listed as dependency
        if ! dpkg-deb --field "$DEB_FILE" | grep -q "Depends:.*sqlite3"; then
          echo "ERROR: sqlite3 dependency not found in package"
          exit 1
        fi
        echo "✓ sqlite3 dependency correctly listed"
        
        echo ""
        echo "=== Package Metadata Verification: PASSED ==="

    