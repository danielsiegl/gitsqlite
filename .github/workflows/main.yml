# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Build gitsqlite

on:
  push:
  
jobs:
  build:
    defaults:
      run:
        shell: pwsh
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
        cache: false

    - name: Build
      run: ./scripts/build.ps1
    
    - name: Upload binary Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin/**/*
        retention-days: 5

  test-ubuntu-amd64:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    
    - name: Make Linux binary executable
      run: chmod +x bin/gitsqlite-linux-amd64
    
    - name: Install SQLite3 if needed
      run: |
        if ! command -v sqlite3 &> /dev/null; then
          echo "SQLite3 not found, installing..."
          sudo apt-get update && sudo apt-get install -y sqlite3
        else
          echo "SQLite3 is already available: $(which sqlite3)"
          sqlite3 --version
        fi
    
    - name: Create test database
      shell: pwsh
      run: ./scripts/createtestdatabase.ps1
    
    - name: Run integrated smoketest
      run: |
        echo "Step 1: Database -> SQL (clean)"
        ./bin/gitsqlite-linux-amd64 clean < smoketest.db > smoketest_output1.sql
        
        echo "Step 2: SQL -> Database (smudge)"
        ./bin/gitsqlite-linux-amd64 smudge < smoketest_output1.sql > smoketest_output2.db
        
        echo "Step 3: Database -> SQL (clean again)"
        ./bin/gitsqlite-linux-amd64 clean < smoketest_output2.db > smoketest_output2.sql
    
    - name: Evaluate test results
      shell: pwsh
      run: ./scripts/evaluatetest.ps1

    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-ubuntu-amd64
        path: '*.sql'
        retention-days: 5

  test-ubuntu-arm64:
    needs: build
    runs-on: ubuntu-24.04-arm
    steps:
    - uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    
    - name: Make Linux ARM64 binary executable
      run: chmod +x bin/gitsqlite-linux-arm64
    
    - name: Install SQLite3 if needed
      run: |
        if ! command -v sqlite3 &> /dev/null; then
          echo "SQLite3 not found, installing..."
          sudo apt-get update && sudo apt-get install -y sqlite3
        else
          echo "SQLite3 is already available: $(which sqlite3)"
          sqlite3 --version
        fi
    
    - name: Create test database
      shell: pwsh
      run: ./scripts/createtestdatabase.ps1
    
    - name: Run integrated smoketest on ARM64
      run: |
        echo "Step 1: Database -> SQL (clean)"
        ./bin/gitsqlite-linux-arm64 clean < smoketest.db > smoketest_output1.sql
        
        echo "Step 2: SQL -> Database (smudge)"
        ./bin/gitsqlite-linux-arm64 smudge < smoketest_output1.sql > smoketest_output2.db
        
        echo "Step 3: Database -> SQL (clean again)"
        ./bin/gitsqlite-linux-arm64 clean < smoketest_output2.db > smoketest_output2.sql
    
    - name: Evaluate test results
      shell: pwsh
      run: ./scripts/evaluatetest.ps1

    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-ubuntu-arm64
        path: '*.sql'
        retention-days: 5

  test-macos-arm64:
    needs: build
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    
    - name: Make macOS binary executable
      run: chmod +x bin/gitsqlite-macos-arm64
    
    - name: Install SQLite3 if needed
      run: |
        if ! command -v sqlite3 &> /dev/null; then
          echo "SQLite3 not found, installing..."
          brew install sqlite
        else
          echo "SQLite3 is already available: $(which sqlite3)"
          sqlite3 --version
        fi
    
    - name: Create test database
      shell: pwsh
      run: ./scripts/createtestdatabase.ps1
    
    - name: Run integrated smoketest on macOS
      run: |
        echo "Step 1: Database -> SQL (clean)"
        ./bin/gitsqlite-macos-arm64 clean < smoketest.db > smoketest_output1.sql
        
        echo "Step 2: SQL -> Database (smudge)"
        ./bin/gitsqlite-macos-arm64 smudge < smoketest_output1.sql > smoketest_output2.db
        
        echo "Step 3: Database -> SQL (clean again)"
        ./bin/gitsqlite-macos-arm64 clean < smoketest_output2.db > smoketest_output2.sql
    
    - name: Evaluate test results
      shell: pwsh
      run: ./scripts/evaluatetest.ps1

    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-macos-arm64
        path: '*.sql'
        retention-days: 5

  test-windows-amd64:
    needs: build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitsqlite-binaries
        path: bin
    
    - name: Check SQLite3 availability
      shell: pwsh
      run: |
        Write-Host "Checking sqlite3.exe..."
        $sqlite = Get-Command sqlite3.exe -ErrorAction SilentlyContinue
        if (-not $sqlite) {
          choco install sqlite -y
          # path propagation can lag; invoke via absolute path to be safe
          $exe = 'C:\ProgramData\chocolatey\bin\sqlite3.exe'
          & $exe --version
        } else {
          & sqlite3.exe --version
        }
    
    - name: Create test database
      shell: pwsh
      run: ./scripts/createtestdatabase.ps1
    
    - name: Run integrated smoketest on Windows
      shell: pwsh
      run: |
        Write-Host "Step 1: Database -> SQL (clean)"
        $cleanOutput1 = Get-Content smoketest.db -AsByteStream | ./bin/gitsqlite-windows-amd64.exe clean
        [System.IO.File]::WriteAllText("smoketest_output1.sql", $cleanOutput1, [System.Text.UTF8Encoding]::new($false))
        
        Write-Host "Step 2: SQL -> Database (smudge)"
        $sqlContent = [System.IO.File]::ReadAllText("smoketest_output1.sql", [System.Text.UTF8Encoding]::new($false))
        
        # Create a process to handle binary output properly
        $psi = New-Object System.Diagnostics.ProcessStartInfo
        $psi.FileName = "./bin/gitsqlite-windows-amd64.exe"
        $psi.Arguments = "smudge"
        $psi.UseShellExecute = $false
        $psi.RedirectStandardInput = $true
        $psi.RedirectStandardOutput = $true
        $psi.RedirectStandardError = $true
        
        $proc = [System.Diagnostics.Process]::Start($psi)
        $proc.StandardInput.Write($sqlContent)
        $proc.StandardInput.Close()
        
        # Read binary output
        $outputStream = $proc.StandardOutput.BaseStream
        $buffer = New-Object byte[] 4096
        $ms = New-Object System.IO.MemoryStream
        while (($read = $outputStream.Read($buffer, 0, $buffer.Length)) -gt 0) {
            $ms.Write($buffer, 0, $read)
        }
        $proc.WaitForExit()
        
        if ($proc.ExitCode -ne 0) {
            throw "Step 2 failed with exit code $($proc.ExitCode)"
        }
        
        [System.IO.File]::WriteAllBytes("smoketest_output2.db", $ms.ToArray())
        $ms.Close()
        
        Write-Host "Step 3: Database -> SQL (clean again)"
        $cleanOutput2 = Get-Content smoketest_output2.db -AsByteStream | ./bin/gitsqlite-windows-amd64.exe clean
        [System.IO.File]::WriteAllText("smoketest_output2.sql", $cleanOutput2, [System.Text.UTF8Encoding]::new($false))

    - name: Evaluate test results
      shell: pwsh
      run: ./scripts/evaluatetest.ps1

    - name: Upload SQL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sql-artifacts-windows-amd64
        path: '*.sql'
        retention-days: 5
    